# WebSocket API: Команды и События

Документация протокола общения между backend-клиентом (app) и Application.py через WebSocket.

**Порт:** 8765 (по умолчанию)
**Регистрация:** При подключении клиент отправляет JSON с именем клиента.
```json
{
  "client_id": "app"
}
```
**Примечание:** После успешной регистрации сервер автоматически отправляет событие `device_info`.

---

## Содержание

1. [Команды (app → server)](#команды-app--server)
2. [События (server → app)](#события-server--app)
3. [Состояния системы](#состояния-системы)
4. [Жизненный цикл операции](#жизненный-цикл-операции)

---

## Команды (app → server)

### device_init

| Параметр | Значение |
|----------|----------|
| **Что делает** | Инициализирует устройство конфигурацией |
| **Когда вызывать** | При старте клиента или изменении настроек |
| **Формат** | `{"command": "device_init", "config": {...}}` |
| **Параметры** | Объект `config` с настройками |
| **Ответ** | Событие `device_init_ack` |

**Пример:**
```json
{
  "command": "device_init",
  "config": {
    "max_plastic_count": 500,
    "max_aluminum_count": 300,
    "plastic_bag_count": 2,
    "aluminum_bag_count": 1,
    "accepted_types": ["plastic", "aluminum"]
  }
}
```

---

### get_device_info

| Параметр | Значение |
|----------|----------|
| **Что делает** | Запрашивает полную информацию об устройстве |
| **Когда вызывать** | При запуске клиента, периодически для мониторинга |
| **Формат** | `{"command": "get_device_info"}` |
| **Параметры** | Нет |
| **Ответ** | Событие `device_info` |

---

### get_photo

| Параметр | Значение |
|----------|----------|
| **Что делает** | Запрашивает фото с камеры |
| **Когда вызывать** | Диагностика, ручной запрос фото |
| **Формат** | `{"command": "get_photo"}` |
| **Параметры** | Нет |
| **Ответ** | Событие `photo_ready` |
| **Таймаут** | 2 секунды (на стороне Application.py) |

**Примечания:**
- Фото сохраняется на устройстве в папку `imgs/`
- В ответе возвращается абсолютный путь к файлу (`photo_path`)
- Base64 изображения в ответе **отсутствует** (для экономии трафика)

---

### dump_container

| Параметр | Значение |
|----------|----------|
| **Что делает** | Инициирует сброс контейнера в сборник |
| **Когда вызывать** | После события `container_recognized` |
| **Формат** | `{"command": "dump_container", "container_type": "plastic"}` |
| **Параметры** | `plastic` или `aluminum` |
| **Ответ** | Событие `container_dumped`, затем `container_accepted` |

**Примечания:**
- `plastic` → движение каретки влево (состояние `DUMPING_PLASTIC`)
- `aluminum` → движение каретки вправо (состояние `DUMPING_ALUMINUM`)
- Таймаут движения: 3 секунды (при превышении → `hardware_error`)

---

### container_unloaded

| Параметр | Значение |
|----------|----------|
| **Что делает** | Уведомляет о выгрузке мешка, сбрасывает счётчик |
| **Когда вызывать** | После физической выгрузки мешка оператором |
| **Формат** | `{"command": "container_unloaded", "container_type": "plastic"}` |
| **Параметры** | `plastic` или `aluminum` |
| **Ответ** | Событие `container_unloaded_ack` |

**Примечания:**
- СЧЕТЧИКИ В ПЛК НЕ РАБОТАЮТ (всегда возвращают 0)

---

### restore_device

| Параметр | Значение |
|----------|----------|
| **Что делает** | Восстанавливает устройство из состояния ERROR |
| **Когда вызывать** | После устранения аппаратной ошибки (затора) |
| **Формат** | `{"command": "restore_device"}` |
| **Параметры** | Нет |
| **Ответ** | Событие `restore_device_ack` |

**Примечания:**
- Переводит систему из состояния `ERROR` в `IDLE`
- Не выполняет физических действий, только программный сброс

---

### Управление дверью

| Команда | Что делает |
|---------|-----------|
| `lock_door` | Блокирует дверь (виртуально) |
| `unlock_door` | Разблокирует дверь (виртуально) |

**Формат:** `{"command": "lock_door"}`
**Ответ:** `up_door_locked` или `up_door_unlocked`

---

### Служебные PLC команды

Прямой доступ к регистрам ПЛК. Использовать с осторожностью.

| Команда | Что делает |
|---------|-----------|
| `cmd_full_clear_register` | Очищает все биты регистра команд |
| `cmd_force_move_carriage_left` | Принудительное движение каретки влево |
| `cmd_force_move_carriage_right` | Принудительное движение каретки вправо |

**Формат:** `{"command": "cmd_full_clear_register"}`

---

### Команды-заглушки

Возвращают `{..._ack: {status: "not_implemented"}}`:
- `enter_service_mode`
- `exit_service_mode`
- `open_shutter`
- `reboot_device`

---

## События (server → app)

### receiver_not_empty

| Параметр | Значение |
|----------|----------|
| **Что означает** | В приёмнике появился контейнер |
| **Когда приходит** | При изменении состояния датчиков (bottle_exist или bank_exist = 1) |

```json
{
  "event": "receiver_not_empty",
  "data": {
    "bottle_exist": 0|1,
    "bank_exist": 0|1
  },
  "timestamp": "2025-01-15T12:34:56.789"
}
```
**Примечание:** Возможна ситуация, когда оба значения = 1.

---

### receiver_empty

| Параметр | Значение |
|----------|----------|
| **Что означает** | Приёмник пуст |
| **Когда приходит** | При изменении состояния (оба датчика = 0) |

```json
{
  "event": "receiver_empty",
  "data": {},
  "timestamp": "2025-01-15T12:34:56.789"
}
```

---

### container_detected

| Параметр | Значение |
|----------|----------|
| **Что означает** | Контейнер обнаружен, запущен процесс распознавания |
| **Когда приходит** | При освобождении завесы |

```json
{
  "event": "container_detected",
  "data": {
    "container_type": "plastic|aluminum|unknown"
  },
  "timestamp": "2025-01-15T12:34:56.789"
}
```

---

### container_recognized

| Параметр | Значение |
|----------|----------|
| **Что означает** | Контейнер успешно распознан |
| **Когда приходит** | Vision подтвердил тип контейнера |

```json
{
  "event": "container_recognized",
  "data": {
    "container_type": "plastic|aluminum",
    "confidence": 1.0
  },
  "timestamp": "2025-01-15T12:34:56.789"
}
```

---

### container_not_recognized

| Параметр | Значение |
|----------|----------|
| **Что означает** | Контейнер не распознан или несовпадение типов |
| **Когда приходит** | Vision вернул "none" или данные Vision не совпали с ПЛК |

```json
{
  "event": "container_not_recognized",
  "data": {
    "plc_type": "plastic",
    "vision_type": "aluminum"
  },
  "timestamp": "2025-01-15T12:34:56.789"
}
```

---

### container_dumped

| Параметр | Значение |
|----------|----------|
| **Что означает** | Команда сброса отправлена в ПЛК |
| **Когда приходит** | Сразу после получения команды `dump_container` |

```json
{
  "event": "container_dumped",
  "data": {
    "container_type": "plastic|aluminum"
  },
  "timestamp": "2025-01-15T12:34:56.789"
}
```

---

### container_accepted

| Параметр | Значение |
|----------|----------|
| **Что означает** | Контейнер успешно выгружен в сборник |
| **Когда приходит** | Датчик конца хода каретки сработал |

```json
{
  "event": "container_accepted",
  "data": {
    "container_type": "plastic|aluminum",
    "counter": 0
  },
  "timestamp": "2025-01-15T12:34:56.789"
}
```
**Примечание:** `counter` всегда 0 (НЕ РАБОТАЕТ).

---

### device_info

| Параметр | Значение |
|----------|----------|
| **Что означает** | Информация об устройстве |
| **Когда приходит** | В ответ на команду `get_device_info` или при подключении |

```json
{
  "event": "device_info",
  "data": {
    "bottle_count": 0,
    "bank_count": 0,
    "bottle_fill_percent": 0,
    "bank_fill_percent": 0,
    "state": "idle",
    "left_sensor": 0,
    "center_sensor": 1,
    "right_sensor": 0,
    "weight_error": 0,
    "door_locked": false
  },
  "timestamp": "2025-01-15T12:34:56.789"
}
```
**Статус полей:**
- `*_count`, `*_percent` — НЕ РАБОТАЮТ (всегда 0)
- `door_locked` — виртуальный статус двери

---

### photo_ready

| Параметр | Значение |
|----------|----------|
| **Что означает** | Фото сохранено на диске |
| **Когда приходит** | В ответ на команду `get_photo` |

```json
{
  "event": "photo_ready",
  "data": {
    "photo_path": "/home/radxa/WS_Bottles/imgs/photo_20250115_123456.jpg",
    "timestamp": "..."
  },
  "timestamp": "..."
}
```

---

### up_door_locked / up_door_unlocked

События подтверждения блокировки/разблокировки двери.

```json
{
  "event": "up_door_locked",
  "data": {"status": "ok"}
}
```

---

## Состояния системы

| Состояние | Описание |
|-----------|----------|
| `idle` | Ожидание |
| `waiting_vision` | Ожидание ответа Vision |
| `dumping_plastic` | Сброс пластика |
| `dumping_aluminum` | Сброс алюминия |
| `error` | Ошибка (разрешен `dump_container` для устранения затора) |

---

## Жизненный цикл

1. **Обнаружение:** Датчик сработал → `receiver_not_empty`.
2. **Ожидание:** Рука убрана (завеса 1->0) → `container_detected` → `WAITING_VISION`.
3. **Распознавание:** Vision + ПЛК → `container_recognized` (`plastic`/`aluminum`).
4. **Сброс:** Клиент шлет `dump_container` → `container_dumped` → `DUMPING_*`.
5. **Прием:** Каретка доехала → `container_accepted`.
6. **Выгрузка:** Клиент шлет `container_unloaded` → `container_unloaded_ack`.
